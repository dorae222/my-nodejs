<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì±… ëª©ë¡</title>
  <link rel="stylesheet" href="./stylesheets/style.css">
</head>
<body>
  <h1>ğŸ“š ì±… ëª©ë¡</h1>
  <ul id="book-list">
      <% books.forEach((book) => { %>
      <!-- user defined(data-id) -->
      <li data-id="<%=book.id%>"> 
        <span class="book-title" style="cursor:pointer; color:blue; text-decoration:underline;">
          <%=book.title %>
        </span>
        <!-- ì‚­ì œ ë²„íŠ¼ -->
        <button class="delete-btn">ì‚­ì œ</button>
        <!-- ìˆ˜ì • ë²„íŠ¼ -->
        <!-- ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™ -->
        <form action="/form/<%=book.id%>" style="display:inline;">
          <button type="submit">ìˆ˜ì •</button>
        </form>
      </li>
      <% }) %>
  </ul>

  <h2>ìƒˆ ì±… ì¶”ê°€</h2>
  <!-- í˜„ì¬ ê²½ë¡œ : [GET] localhost:3000/books -->
  <!-- ì¶”ê°€ ìš”ì²­ : [POST]localhost:3000/books -->
  <!-- form usually with synchronous -->
  <form action="/books" method="post">
    <input type="text" placeholder="ì œëª©" name="title" required>
    <input type="text" placeholder="ì €ì" name="author" required>
    <!-- <input type="submit" value="ì¶”ê°€"> -->
    <button type="submit">ì¶”ê°€</button>
  </form>

  <h2>ğŸ“– ì„ íƒí•œ ì±… ìƒì„¸ì •ë³´</h2>
  <div id="book-detail">ì œëª©ì„ í´ë¦­í•˜ë©´ ìƒì„¸ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

  <script>
    // ì‚¬ìš©ìë“¤ì€ ì±… ì œëª©ì„ í´ë¦­ (íƒœê·¸: <span class="book-title"> â†’ ë°˜ë³µë¬¸ ì‚¬ìš©í•˜ì—¬ ê° íƒœê·¸ì— ì´ë²¤íŠ¸ ì ìš©)
    // getElemtById â†’ HTML ELEMENT (ìš”ì†Œ 1ê°œ)
    // guerySelectorAll â†’ HTML COLLECTION (ìš”ì†Œ ì—¬ëŸ¬ê°œ. ë°°ì—´ í˜•íƒœì™€ ìœ ì‚¬) â†’ forEach ì‚¬ìš© ê°€ëŠ¥
    document.querySelectorAll('.book-title').forEach((titleElement)=>{
      // titleElement(span íƒœê·¸)
      // â†’ í•´ë‹¹ íƒœê·¸ê°€ í´ë¦­ë˜ì—ˆì„ ë•Œ í•´ë‹¹ ë¶€ë¶„ì— ì¶œë ¥ë˜ì–´ ìˆëŠ” ì±…ì˜ ìƒì„¸ ì •ë³´ë¥¼ ìš”ì²­
      titleElement.addEventListener('click', async (event) => { // event: í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒì‹œ ìë™ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ê°ì²´(ì´ë²¤íŠ¸ì— ëŒ€í•œ ì •ë³´)
        // event.target: ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ íƒ€ê²Ÿ (ì‚¬ìš©ìê°€ í´ë¦­í•œ span íƒœê·¸)
        const li = event.target.closest('li'); // í´ë¦­í•œ span íƒœê·¸ë¥¼ ê°ì‹¸ëŠ” liíƒœê·¸ë¥¼ ê°€ì§€ê³  ì˜´
        const bookId = li.getAttribute('data-id'); // 1, 2, ...
        // console.log(bookId);

        // fetch() : ë¹„ë™ê¸° ìš”ì²­ì„ ìœ„í•œ í•¨ìˆ˜ â†’ ì„œë²„ë¡œ ì±… ìƒì„¸ ì •ë³´ ìš”ì²­
        // 1. .then() .. ~ : ì½œë°± í•¨ìˆ˜
        // 2. async/await : ì½œë°± í•¨ìˆ˜ê°€ ì—†ì–´ ì½”ë“œê°€ ë” ê°„ê²°
        const res = await fetch(`/books/${bookId}`); // [GET] localhost:3000/books/id
        const book = await res.json() // json() â†’ ë¹„ë™ê¸°

        let html = '<p>id: '+book.id+'</p>';
        html += '<p>title: '+book.title+'</p>';
        html += '<p>author: '+book.author+'</p>';

        // innerHTML : íƒœê·¸ í¬í•¨
        // innerText : íƒœê·¸ ë¯¸í¬í•¨(í…ìŠ¤íŠ¸ë¡œë§Œ), íƒœê·¸ ì¸ì‹ X
        // value : input íƒœê·¸ì˜ value ì†ì„± ê°’
        document.getElementById('book-detail').innerHTML = html;
      });
    });

    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.delete-btn').forEach((btn) => { // btn: ì‚­ì œ ë²„íŠ¼
      btn.addEventListener('click', (e) => {
        const li = e.target.closest('li');
        const bookId = li.getAttribute('data-id');
        fetch(`/books/${bookId}`, { // [DELETE] localhost:3000/books/id
          method: 'DELETE'
        });

        if (res.ok) {
          // ì±… ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œ ëœ ì±…ì´ ì¶œë ¥ë˜ëŠ” ë¶€ë¶„ì„ ì‚­ì œ
          li.remove(); // li ìš”ì†Œ ì‚­ì œ
        }
      });
    });
  </script>
</body>
</html>