<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜¤ëŠ˜ì˜ í•  ì¼</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <h1>ğŸ“‹ ì˜¤ëŠ˜ì˜ í•  ì¼</h1>
  <ul id="todo-list">
    <% todos.forEach((todo)=>{%>
      <li data-id="<%=todo.id%>">
        <input type="checkbox" class="toggle-check" <%=todo.completed ? 'checked' : '' %> >
        <span>
          <%=todo.task%>
        </span>
        <!-- ìˆ˜ì • ë²„íŠ¼ => edit.ejs í˜ì´ì§€ë¡œ ì´ë™ -->
        <form action="/todos/edit/<%=todo.id%>" method="GET" style="display:inline;">
          <button type="submit">ìˆ˜ì •</button>
        </form>
        <button class="delete-btn">ì‚­ì œ</button>
      </li>
    <%}); %>  
  </ul>

  <h2>ìƒˆë¡œìš´ í•  ì¼ ì¶”ê°€</h2>
  <!-- * form íƒœê·¸ ê¸°ë³¸ ì†ì„± ì‹ ê²½ ì“¸ê²ƒ! -->
  <form action="/todos" method="post">
    <input type="text" name="task" placeholder="ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required>
    <button type="submit">ì¶”ê°€</button>
  </form>

  <script>
    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        //1. ì„ íƒí•œ to-do ë¦¬ìŠ¤íŠ¸ì˜ id ê°’ ê°€ì ¸ì˜¤ê¸°
        const li = e.target.closest('li');
        const todoId = li.getAttribute('data-id');

        //2. 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' ë¥¼ í™•ì¸ì°½ìœ¼ë¡œ ë„ìš´ í›„ ì·¨ì†Œ ì„ íƒ ì‹œ ë”ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
        const del = confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if(!del) return; //í˜„ì¬ í•¨ìˆ˜ ë§ˆë¬´ë¦¬(ë”ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ)
        
        //3. ì‚­ì œ ìš”ì²­ ê²½ë¡œë¡œ ìš”ì²­ (fetch API í™œìš©)
        const res = await fetch(`/todos/${todoId}`,{
            method : 'DELETE'
        });

        //4. 200 OK ì½”ë“œê°€ ì‘ë‹µì˜¬ ê²½ìš° í•´ë‹¹ li íƒœê·¸ í™”ë©´ì—ì„œ ì‚­ì œ
        //   ì‚­ì œê°€ ì•ˆëœ ê²½ìš°ì—ëŠ” 'ì‚­ì œ ì‹¤íŒ¨' ì•Œë¦¼ì°½ ë„ìš°ê¸°
        if(res.ok){
            li.remove();
        }else{
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }

      });
    });

    document.querySelectorAll('.toggle-check').forEach((check)=>{
      check.addEventListener('click', async (e)=>{
        const li = e.target.closest('li');
        const todoId = li.getAttribute('data-id');

        //[PATCH]localhost:3000/todos/1(ì•„ì´ë””)/completed
        const res = await fetch(`/todos/${todoId}/completed`, {
          method : 'PATCH'
        });

        if(res.ok){
          alert('ì™„ë£Œ ìƒíƒœ ë³€ê²½ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
        }else{
          alert('ì‚­ì œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      });
    });


  </script>
</body>
</html>